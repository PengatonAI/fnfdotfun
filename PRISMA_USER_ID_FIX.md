# Prisma User ID Fix - Complete Solution

## Problem
The profile page was redirecting to login because `session.user.id` was not matching a real Prisma User.id. The JWT callback was setting `token.id` to the OAuth provider's user ID (Google/Twitter ID) instead of the Prisma User.id.

## Root Cause
- `user.id` in JWT callback is the OAuth provider's ID (e.g., Google user ID, Twitter user ID)
- Prisma User.id is a `cuid()` generated ID, not the provider's ID
- The code was using `token.id = user.id` which set it to the provider's ID
- Database queries like `SELECT * FROM User WHERE id = <session.user.id>` failed because the ID didn't exist in Prisma

## Solution

### 1. JWT Callback - Always Fetch/Create Prisma User by Email

**Before**: Used `token.id = user.id` (OAuth provider ID)

**After**: 
- Fetch existing Prisma User by email: `prisma.user.findUnique({ where: { email: user.email } })`
- If not found, create new Prisma User (Prisma generates `cuid()` ID)
- Set `token.id = prismaUser.id` (Prisma User.id, NOT provider ID)

```typescript
async jwt({ token, user, account, trigger }) {
  if (user) {
    // Fetch or create Prisma User by email
    let prismaUser = await prisma.user.findUnique({
      where: { email: user.email },
    });

    if (!prismaUser) {
      // Create new Prisma User (Prisma generates cuid() ID)
      prismaUser = await prisma.user.create({
        data: {
          name: user.name,
          email: user.email,
          image: user.image,
          username: null,
          xHandle: null,
        },
      });
    }

    // CRITICAL: Set token.id to Prisma User.id (NOT OAuth provider's user.id)
    token.id = prismaUser.id;
  }
  return token;
}
```

### 2. Session Callback - Always Use token.id (Prisma User.id)

**Before**: Used `token.id || token.sub` (could be provider ID)

**After**: 
- Always use `token.id` (which is now always Prisma User.id)
- Never use `token.sub` as fallback
- Throw error if `token.id` is missing

```typescript
async session({ session, token }) {
  // token.id is always the Prisma User.id (set in JWT callback)
  if (!token.id) {
    throw new Error("Session callback: Missing user ID in token");
  }
  
  session.user.id = token.id as string; // Prisma User.id
  return session;
}
```

### 3. SignIn Callback - Simplified

**Before**: Tried to create/update user with provider ID as Prisma ID

**After**: 
- Simplified to just return `true` (allow sign-in)
- User creation/lookup is handled in JWT callback to ensure `token.id` is Prisma User.id

### 4. Logging

Added comprehensive logging to verify:
- `token.id` in JWT callback (should be Prisma User.id)
- `session.user.id` in session callback (should match token.id)
- OAuth provider user.id vs Prisma User.id

**Expected Logs**:
```
ðŸ”‘ JWT CALLBACK: Set token.id = Prisma User.id: <prisma-user-id> OAuth provider user.id was: <provider-id> email: <email>
âœ… SESSION CALLBACK: Set session.user.id = token.id (Prisma User.id): <prisma-user-id>
```

## Verification

After this fix:
1. âœ… `session.user.id` is always a real Prisma User.id
2. âœ… Database query `SELECT * FROM User WHERE id = <session.user.id>` always returns a user
3. âœ… Profile page works without redirecting to login
4. âœ… All providers (Google, X, Wallet) use the same logic

## Testing

1. **Login with Google**:
   - Check logs: `token.id` should be Prisma User.id (cuid format)
   - Profile page should load without redirect
   - Database query should return user

2. **Login with X/Twitter**:
   - Check logs: `token.id` should be Prisma User.id (cuid format)
   - Profile page should load without redirect
   - Database query should return user

3. **Login with Wallet**:
   - Wallet connection doesn't use OAuth, so this is handled separately
   - If wallet login creates a user, it should also use Prisma User.id

## Key Changes

### `lib/auth-config.ts`

1. **JWT Callback**:
   - Fetches/creates Prisma User by email (not by provider ID)
   - Sets `token.id = prismaUser.id` (Prisma User.id)
   - Stores Prisma user data in token (email, name, image, username, xHandle)

2. **Session Callback**:
   - Always uses `token.id` (Prisma User.id)
   - Never uses `token.sub` as fallback
   - Throws error if `token.id` is missing

3. **SignIn Callback**:
   - Simplified to just return `true`
   - User creation handled in JWT callback

## Important Notes

- **Never use `token.sub` for `token.id`** - `token.sub` is the OAuth provider's user ID
- **Never use `user.id` directly** - `user.id` is the OAuth provider's user ID, not Prisma User.id
- **Always fetch/create Prisma User by email** - Email is the unique identifier across providers
- **Prisma User.id is always a `cuid()`** - Generated by Prisma, not by OAuth providers

## Result

âœ… `session.user.id` always matches a real row in the Prisma User table
âœ… `SELECT * FROM User WHERE id = <session.user.id>` always returns a user
âœ… Profile page works correctly
âœ… All authentication flows work with Prisma User.id

